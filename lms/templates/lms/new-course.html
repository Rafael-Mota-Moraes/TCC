{% extends "global/base.html" %}

{% block content %}
  <h1>Cadastrar Curso</h1>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ course_form.as_p }}

    <h2>Módulos</h2>
    {{ module_formset.management_form }}
    <div id="modules" class="sortable-container">
      {% for module_form in module_formset %}
        <div class="module" data-id="{{ module_form.instance.id|default:'new' }}" draggable="true">
          {{ module_form.as_p }}
          
          {% if module_form.instance.id %}
            <input type="hidden" name="{{ module_form.prefix }}-id" value="{{ module_form.instance.id }}">
          {% endif %}
          
          <h3>Aulas deste módulo:</h3>
          <div class="lectures sortable-container" data-module-id="{{ module_form.instance.id|default:forloop.counter0 }}">
            {% if module_form.nested %}
              {% for lecture_form in module_form.nested %}
                <div class="lecture" data-id="{{ lecture_form.instance.id|default:'new' }}" draggable="true">
                  {{ lecture_form.as_p }}
                  {% if lecture_form.instance.id %}
                    <input type="hidden" name="{{ lecture_form.prefix }}-id" value="{{ lecture_form.instance.id }}">
                  {% endif %}
                  <button type="button" class="remove-lecture">Remover Aula</button>
                </div>
              {% endfor %}
            {% endif %}
          </div>
          <button type="button" class="add-lecture" data-module-index="{{ forloop.counter0 }}">Adicionar Aula</button>
          <button type="button" class="remove-module">Remover Módulo</button>
        </div>
      {% endfor %}
    </div>
    <button type="button" id="add-module">Adicionar Módulo</button>

    <button type="submit">Salvar</button>
  </form>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Management form elements
      const moduleFormPrefix = "{{ module_formset.prefix }}";
      const totalFormsInput = document.querySelector(`input[name="${moduleFormPrefix}-TOTAL_FORMS"]`);
      let moduleCounter = parseInt(totalFormsInput.value);
      
      // Initialize all sortable containers
      initializeSortable();
      
      // Handle adding module
      document.getElementById('add-module').addEventListener('click', function() {
        addModule();
      });
      
      // Delegate event for removing modules
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-module')) {
          removeModule(e.target);
        } else if (e.target.classList.contains('add-lecture')) {
          addLecture(e.target);
        } else if (e.target.classList.contains('remove-lecture')) {
          removeLecture(e.target);
        }
      });

      // Function to initialize sortable functionality
      function initializeSortable() {
        const containers = document.querySelectorAll('.sortable-container');
        
        containers.forEach(container => {
          // Remove existing listeners to prevent duplicates
          container.removeEventListener('dragstart', handleDragStart);
          container.removeEventListener('dragend', handleDragEnd);
          container.removeEventListener('dragover', handleDragOver);
          container.removeEventListener('drop', handleDrop);
          
          // Add listeners
          container.addEventListener('dragstart', handleDragStart);
          container.addEventListener('dragend', handleDragEnd);
          container.addEventListener('dragover', handleDragOver);
          container.addEventListener('drop', handleDrop);
        });
      }
      
      // Drag event handlers
      function handleDragStart(e) {
        // Only allow dragging modules within modules container and lectures within lectures container
        if ((e.target.classList.contains('module') && this.id === 'modules') || 
            (e.target.classList.contains('lecture') && this.classList.contains('lectures'))) {
          e.target.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', e.target.dataset.id);
        }
      }
      
      function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        updateOrder(this);
      }
      
      function handleDragOver(e) {
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        
        // Check if we're in the right container
        if ((dragging.classList.contains('module') && this.id === 'modules') || 
            (dragging.classList.contains('lecture') && this.classList.contains('lectures'))) {
          const afterElement = getDragAfterElement(this, e.clientY);
          if (afterElement === null) {
            this.appendChild(dragging);
          } else {
            this.insertBefore(dragging, afterElement);
          }
        }
      }
      
      function handleDrop(e) {
        e.preventDefault();
        updateOrder(this);
      }

      function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll(
          container.id === 'modules' ? '.module:not(.dragging)' : '.lecture:not(.dragging)'
        )];
        
        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
      }

      // Update order of items in container
      function updateOrder(container) {
        if (container.id === 'modules') {
          // Update modules order
          const modules = container.querySelectorAll('.module');
          modules.forEach((module, index) => {
            const orderInput = module.querySelector(`input[name$="-order"]`);
            if (orderInput) {
              orderInput.value = index;
            }
          });
        } else if (container.classList.contains('lectures')) {
          // Update lectures order within a specific module
          const lectures = container.querySelectorAll('.lecture');
          lectures.forEach((lecture, index) => {
            const orderInput = lecture.querySelector(`input[name$="-order"]`);
            if (orderInput) {
              orderInput.value = index;
            }
          });
        }
      }
      
      // Add new module
      function addModule() {
        const modulesContainer = document.getElementById('modules');
        
        const newModuleHtml = `
          <div class="module" data-id="new" draggable="true">
            <label for="id_${moduleFormPrefix}-${moduleCounter}-title">Título do Módulo:</label>
            <input type="text" name="${moduleFormPrefix}-${moduleCounter}-title" id="id_${moduleFormPrefix}-${moduleCounter}-title" required>
            
            <label for="id_${moduleFormPrefix}-${moduleCounter}-order">Ordem:</label>
            <input type="number" name="${moduleFormPrefix}-${moduleCounter}-order" id="id_${moduleFormPrefix}-${moduleCounter}-order" value="${moduleCounter}">
            
            <h3>Aulas deste módulo:</h3>
            <div class="lectures sortable-container" data-module-id="${moduleCounter}"></div>
            
            <button type="button" class="add-lecture" data-module-index="${moduleCounter}">Adicionar Aula</button>
            <button type="button" class="remove-module">Remover Módulo</button>
          </div>
        `;
        
        modulesContainer.insertAdjacentHTML('beforeend', newModuleHtml);
        moduleCounter++;
        totalFormsInput.value = moduleCounter;
        
        // Reinitialize sortable containers to include the new one
        initializeSortable();
        updateOrder(modulesContainer);
      }
      
      // Remove module
      function removeModule(button) {
        const moduleElement = button.closest('.module');
        moduleElement.remove();
        
        // Update the form count and order
        moduleCounter--;
        totalFormsInput.value = moduleCounter;
        
        // Update the order of remaining modules
        const modulesContainer = document.getElementById('modules');
        updateOrder(modulesContainer);
      }
      
      // Add new lecture to a module
      function addLecture(button) {
        const moduleIndex = button.dataset.moduleIndex;
        const lecturesContainer = button.previousElementSibling;
        const lectureCount = lecturesContainer.querySelectorAll('.lecture').length;
        
        const newLectureHtml = `
          <div class="lecture" data-id="new" draggable="true">
            <label for="id_${moduleFormPrefix}-${moduleIndex}-lecture-${lectureCount}-title">Título da Aula:</label>
            <input type="text" name="${moduleFormPrefix}-${moduleIndex}-lecture-${lectureCount}-title" 
              id="id_${moduleFormPrefix}-${moduleIndex}-lecture-${lectureCount}-title" required>
            
            <label for="id_${moduleFormPrefix}-${moduleIndex}-lecture-${lectureCount}-video_content">Conteúdo em vídeo:</label>
            <input type="file" name="${moduleFormPrefix}-${moduleIndex}-lecture-${lectureCount}-video_content" 
              id="id_${moduleFormPrefix}-${moduleIndex}-lecture-${lectureCount}-video_content" required>
            
            <label for="id_${moduleFormPrefix}-${moduleIndex}-lecture-${lectureCount}-order">Ordem:</label>
            <input type="number" name="${moduleFormPrefix}-${moduleIndex}-lecture-${lectureCount}-order" 
              id="id_${moduleFormPrefix}-${moduleIndex}-lecture-${lectureCount}-order" value="${lectureCount}">
            
            <button type="button" class="remove-lecture">Remover Aula</button>
          </div>
        `;
        
        lecturesContainer.insertAdjacentHTML('beforeend', newLectureHtml);
        
        // Update lecture order
        updateOrder(lecturesContainer);
      }
      
      // Remove lecture
      function removeLecture(button) {
        const lectureElement = button.closest('.lecture');
        const lecturesContainer = lectureElement.parentElement;
        
        lectureElement.remove();
        
        // Update lecture order
        updateOrder(lecturesContainer);
      }
    });
  </script>

  <style>
    .module, .lecture {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      background-color: #f9f9f9;
      cursor: move;
    }

    .module {
      background-color: #f0f0f0;
    }

    .lecture {
      background-color: #f9f9f9;
      margin-left: 20px;
    }

    .dragging {
      opacity: 0.5;
      border: 2px dashed #999;
    }

    .module:hover, .lecture:hover {
      background-color: #e9e9e9;
    }

    .remove-module, .remove-lecture {
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      margin-top: 10px;
    }

    .remove-module:hover, .remove-lecture:hover {
      background-color: #c0392b;
    }

    #modules, .lectures {
      min-height: 50px;
      padding: 10px;
      border: 2px dashed #ccc;
      border-radius: 5px;
      background-color: #fafafa;
      margin-bottom: 15px;
    }

    #modules {
      margin-bottom: 20px;
    }

    .lectures {
      margin: 15px 0;
    }

    #add-module, .add-lecture {
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }

    #add-module:hover, .add-lecture:hover {
      background-color: #27ae60;
    }
    
    button[type="submit"] {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      font-weight: bold;
    }
    
    button[type="submit"]:hover {
      background-color: #2980b9;
    }
  </style>
{% endblock %}